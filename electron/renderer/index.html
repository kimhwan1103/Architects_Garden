<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Local Notes â€” Main</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ìŠ¤íƒ€ì¼ -->
  <style>
    :root{ --bg:#fafafa; --line:#e5e5e5; --left:280px; --right:360px; }
    *{ box-sizing:border-box } html,body{ height:100%; margin:0; }
    body{ font-family:system-ui, Segoe UI, Apple SD Gothic Neo, Malgun Gothic, sans-serif; background:var(--bg); }
    .layout{ display:grid; grid-template-columns: var(--left) 1fr var(--right); gap:10px; height:100vh; padding:10px; }
    .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto; }
    .split-col{ display:flex; flex-direction:column; gap:10px; height:100% }
    .list{ display:flex; flex-direction:column; gap:6px; }
    .note-item{ padding:8px; border:1px solid transparent; border-radius:8px; cursor:pointer; }
    .note-item:hover{ background:#f7f7f7; } .note-item.active{ background:#eef2ff; border-color:#c7d2fe; }
    .muted{ color:#666; font-size:12px }
    .tag{ background:#efefef; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px }
    input[type=text]{ width:100%; padding:10px; border:1px solid var(--line); border-radius:8px; }
    .row{ display:flex; gap:8px; align-items:center }
    .btn{ padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#f5f5f5; cursor:pointer }
    .primary{ background:#111; color:#fff; border-color:#111 }
    .editor{ display:flex; flex-direction:column; gap:10px; height:100% }
    /* Toast UI Editor ë†’ì´ ë³´ì • */
    #mdEditor{ flex:1; min-height:420px; }
    .toastui-editor-defaultUI{ height:100%; }
    .toastui-editor-main{ height:calc(100% - 44px); } /* toolbar ì œì™¸ */
    .toastui-editor-contents{ font-size:15px; line-height:1.6; }
    /* ë¶„ì„ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ */
    #analysisGoals ul{ margin:6px 0 0 18px; padding:0; }
    #analysisGoals li{ margin:2px 0; }
  </style>

  <!-- Toast UI Editor (CDN) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/svg-pan-zoom@3.6.1/dist/svg-pan-zoom.min.js"></script>
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <!-- Mermaid (ë§ˆì¸ë“œë§µ ë Œë”) -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script> mermaid.initialize({ startOnLoad:false, theme:'default' }); </script>
</head>
<body>
  <div class="layout">
    <!-- ì™¼ìª½: ë…¸íŠ¸ ë¦¬ìŠ¤íŠ¸ -->
    <aside class="panel split-col">
      <div>
        <h2 style="margin:0 0 8px 0;">ë…¸íŠ¸</h2>
        <div class="row">
          <input id="q" type="text" placeholder="ê²€ìƒ‰ (ì œëª©/ë³¸ë¬¸)" />
          <button class="btn" id="searchBtn">ê²€ìƒ‰</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn primary" id="newBtn">ìƒˆ ë…¸íŠ¸</button>
          <button class="btn" id="delBtn">ì‚­ì œ</button>
        </div>
      </div>
      <div class="list" id="noteList"></div>
    </aside>

    <!-- ê°€ìš´ë°: í¸ì§‘ê¸° -->
    <main class="panel editor">
      <div class="row" style="gap:6px;">
        <input id="title" type="text" placeholder="ì œëª©" style="flex:1;" />
        <!-- âœ… AI ë¶„ì„ ë²„íŠ¼ ì¶”ê°€ -->
        <button class="btn" id="analyzeBtn">AI ë¶„ì„</button>
        <button class="btn primary" id="saveBtn">ì €ì¥</button>
      </div>
      <input id="tags" type="text" placeholder="íƒœê·¸: ì‰¼í‘œë¡œ êµ¬ë¶„" />
      <!-- WYSIWYG ë§ˆí¬ë‹¤ìš´ ì—ë””í„° -->
      <div id="mdEditor"></div>
      <div class="muted" id="status">ëŒ€ê¸° ì¤‘</div>
    </main>

    <!-- ì˜¤ë¥¸ìª½: ì–´ì‹œìŠ¤í„´íŠ¸ + ë¶„ì„ ê²°ê³¼ ì˜ì—­ ì¶”ê°€ -->
    <aside class="panel">
      <h2 style="margin:0 0 8px 0;">ì–´ì‹œìŠ¤í„´íŠ¸</h2>

      <!-- âœ… AI ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
      <div style="margin-bottom:10px;">
        <h3 style="margin:0 0 6px 0;">AI ë¶„ì„ ê²°ê³¼</h3>
        <div id="analysisSummary" class="muted" style="margin-bottom:6px;"></div>
        <div id="analysisGoals" style="font-size:14px; line-height:1.5;"></div>

        <!-- âœ… ë§ˆì¸ë“œë§µ ë˜í¼ + íˆ´ë°” -->
        <div id="mindmapWrap" style="position:relative; border:1px solid var(--line); border-radius:8px; height:420px; overflow:hidden;">
          <div class="mm-toolbar" style="position:absolute; right:8px; top:8px; display:flex; gap:6px; z-index:2;">
            <button id="mmZoomIn"  class="btn" title="í™•ëŒ€">ï¼‹</button>
            <button id="mmZoomOut" class="btn" title="ì¶•ì†Œ">ï¼</button>
            <button id="mmReset"   class="btn" title="ë¦¬ì…‹">âŸ³</button>
            <button id="mmFit"     class="btn" title="ë§ì¶¤">â–£</button>
            <button id="mmSaveSVG" class="btn" title="SVG ì €ì¥">SVG</button>
            <button id="mmSavePNG" class="btn" title="PNG ì €ì¥">PNG</button>
          </div>
          <div id="mindmap" style="width:100%; height:100%;"></div>
        </div>
      </div>

      <div id="chatLog" style="border:1px solid var(--line); border-radius:8px; padding:8px; height:38%; overflow:auto"></div>
      <div class="row" style="margin-top:8px;">
        <input id="chatInput" type="text" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦" style="flex:1;" />
        <button class="btn primary" id="sendBtn">ë³´ë‚´ê¸°</button>
        <button class="btn" id="clearChat">ì§€ìš°ê¸°</button>
      </div>
    </aside>
  </div>

  <!-- ===== ìŠ¤í¬ë¦½íŠ¸ ===== -->
  <script>
    const API = "http://127.0.0.1:8421/api";
    const $ = s => document.querySelector(s);

    // DOM
    const noteListEl = $("#noteList");
    const qEl = $("#q"), searchBtn = $("#searchBtn");
    const newBtn = $("#newBtn"), delBtn = $("#delBtn");
    const titleEl = $("#title"), tagsEl = $("#tags"), saveBtn = $("#saveBtn"), statusEl = $("#status");
    const analyzeBtn = $("#analyzeBtn");                        // âœ…
    const analysisSummaryEl = $("#analysisSummary");            // âœ…
    const analysisGoalsEl   = $("#analysisGoals");              // âœ…
    const mindmapEl         = $("#mindmap");                    // âœ…
    const chatLogEl = $("#chatLog"), chatInputEl = $("#chatInput"),
          sendBtn = $("#sendBtn"), clearChatBtn = $("#clearChat");

    // ìƒíƒœ
    let currentId = null;
    let notes = [];
    let chatHistory = [];
    let editor = null; // Toast UI Editor ì¸ìŠ¤í„´ìŠ¤
    let mmPan = null;

    const escapeHtml = s => (s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const debounce = (fn, ms=500) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

    // ===== ì—ë””í„° =====
    function initEditor() {
      editor = new toastui.Editor({
        el: document.querySelector('#mdEditor'),
        height: '100%',
        initialEditType: 'markdown',   // í¸ì§‘ê³¼ ë Œë”ë¥¼ í•œ í™”ë©´ì—ì„œ
        previewStyle: 'tab',
        usageStatistics: false,
        placeholder: 'ì—¬ê¸°ì— ë§ˆí¬ë‹¤ìš´ì„ ì…ë ¥í•˜ì„¸ìš”â€¦',
        toolbarItems: [
          ['heading','bold','italic','strike'],
          ['hr','quote'],
          ['ul','ol','task'],
          ['table','link','image','code','codeblock'],
        ]
      });
      editor.on('change', () => { statusEl.textContent = 'í¸ì§‘ ì¤‘â€¦'; autoSave(); });
    }
    function getContent(){ return editor ? editor.getMarkdown() : ''; }
    function setContent(v){ if (editor) editor.setMarkdown(v || ''); }

    // ===== ë¦¬ìŠ¤íŠ¸ =====
    function renderList() {
      noteListEl.innerHTML = "";
      if (!Array.isArray(notes) || notes.length === 0) {
        noteListEl.innerHTML = `<div class="muted">ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      for (const n of notes) {
        const div = document.createElement("div");
        div.className = "note-item" + (n.id === currentId ? " active" : "");
        const when = new Date(n.updated_at).toLocaleString();
        div.innerHTML = `
          <div><strong>${escapeHtml(n.title)}</strong></div>
          <div class="muted" style="font-size:12px">${when}</div>
          <div>${(n.tags||[]).slice(0,3).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join("")}</div>`;
        div.onclick = () => loadNote(n.id);
        noteListEl.appendChild(div);
      }
    }
    async function fetchList() {
      const url = qEl.value.trim() ? `${API}/notes?query=${encodeURIComponent(qEl.value)}` : `${API}/notes`;
      const res = await fetch(url);
      if (!res.ok) { console.error('GET /api/notes ì‹¤íŒ¨', res.status); return; }
      notes = await res.json(); renderList();
    }

    // ===== í¸ì§‘/ë¡œë“œ/ì €ì¥ =====
    function setEditor(n) {
      currentId = n?.id || null;
      titleEl.value = n?.title || "";
      tagsEl.value = (n?.tags || []).join(", ");
      setContent(n?.content || "");
      statusEl.textContent = currentId ? `í¸ì§‘ ì¤‘: ${currentId}` : "ìƒˆ ë…¸íŠ¸ ì‘ì„±";
      renderList();
    }
    async function loadNote(id) {
      const res = await fetch(`${API}/notes/${id}`);
      if (!res.ok) return;
      setEditor(await res.json());
    }
    async function createNote() {
      const res = await fetch(`${API}/notes`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ title:"ìƒˆ ë…¸íŠ¸", content:"", tags:[] })
      });
      if (!res.ok) return;
      const n = await res.json();
      await fetchList(); await loadNote(n.id);
    }
    async function saveNote() {
      const body = {
        title: titleEl.value.trim(),
        content: getContent(), // ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì €ì¥
        tags: tagsEl.value.split(",").map(s=>s.trim()).filter(Boolean)
      };
      if (!body.title) { statusEl.textContent = "ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."; return; }
      let res;
      if (!currentId) {
        res = await fetch(`${API}/notes`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if (!res.ok) return;
        currentId = (await res.json()).id;
        statusEl.textContent = "ìƒˆ ë…¸íŠ¸ ì €ì¥ ì™„ë£Œ";
      } else {
        res = await fetch(`${API}/notes/${currentId}`, { method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        if (!res.ok) return;
        statusEl.textContent = "ì €ì¥ ì™„ë£Œ";
      }
      await fetchList();
    }
    const autoSave = debounce(async ()=>{
      if (!currentId && (titleEl.value.trim() || getContent().trim())) { await createNote(); return; }
      if (currentId) { await saveNote(); }
    }, 1200);
    async function deleteNote() {
      if (!currentId) { statusEl.textContent = "ì‚­ì œí•  ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."; return; }
      if (!confirm("ì •ë§ ì´ ë…¸íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      await fetch(`${API}/notes/${currentId}`, { method:"DELETE" });
      currentId = null; setEditor(null); statusEl.textContent = "ì‚­ì œ ì™„ë£Œ";
      await fetchList();
    }

    // ===== AI ë¶„ì„ ë Œë”ë§ =====
    function renderAnalysis(result){
    // ìš”ì•½/ëª©í‘œ ì˜ì—­ ë¨¼ì € ë Œë”
    analysisSummaryEl.textContent = result.summary || '';
    if (Array.isArray(result.goals) && result.goals.length) {
      const html = result.goals.map(g => {
        const tasks = (g.tasks||[]).map(t => `<li>âœ… ${escapeHtml(t.title||'')}</li>`).join("");
        return `
          <div style="margin:8px 0;">
            <div><strong>ğŸ¯ ${escapeHtml(g.title||'')}</strong></div>
            ${g.rationale ? `<div class="muted">${escapeHtml(g.rationale)}</div>` : ""}
            <ul style="margin:6px 0 0 18px">${tasks}</ul>
          </div>`;
      }).join("");
      analysisGoalsEl.innerHTML = html;
    } else {
      analysisGoalsEl.innerHTML = '<div class="muted">ì œì•ˆëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // Mermaid mindmap (í•œ ë²ˆë§Œ ë Œë”)
    mindmapEl.innerHTML = '';
    const code = result.mermaid || 'graph TD\nROOT[Empty]';
    const id = 'mm' + Math.random().toString(36).slice(2);

    mermaid.render(id, code).then(({ svg }) => {
      mindmapEl.innerHTML = svg;

      // pan/zoom ì ìš©
      const svgEl = mindmapEl.querySelector('svg');
      if (!svgEl) return;

      if (mmPan) { try { mmPan.destroy(); } catch(e){} }

      mmPan = svgPanZoom(svgEl, {
        zoomEnabled: true,
        panEnabled: true,
        controlIconsEnabled: false,
        fit: true,
        center: true,
        minZoom: 0.2,
        maxZoom: 10,             // â† ì¶©ë¶„íˆ í¬ê²Œ
        zoomScaleSensitivity: 0.2
      });
      if (mmPan.enableMouseWheelZoom) mmPan.enableMouseWheelZoom();

      // ì´ˆê¸° ë§ì¶¤
      mmPan.resize();
      mmPan.fit();
      mmPan.center();
    }).catch(err => {
      console.error('mermaid render error', err);
      mindmapEl.textContent = 'ë§ˆì¸ë“œë§µ ë Œë” ì˜¤ë¥˜';
    });
  }

    document.getElementById('mmZoomIn').onclick  = () => mmPan && mmPan.zoomBy(1.2);
    document.getElementById('mmZoomOut').onclick = () => mmPan && mmPan.zoomBy(0.8);
    document.getElementById('mmReset').onclick   = () => {
      if (!mmPan) return;
      mmPan.zoom(1); mmPan.center();
    };
    document.getElementById('mmFit').onclick     = () => {
      if (!mmPan) return;
      mmPan.resize(); mmPan.fit(); mmPan.center();
    };

    // âœ… ì°½ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìë™ ë§ì¶¤
    window.addEventListener('resize', () => {
      if (!mmPan) return;
      mmPan.resize(); mmPan.fit(); mmPan.center();
    });

    const ipcRenderer = (window.require && window.require('electron'))
      ? window.require('electron').ipcRenderer
      : null;

    //í˜„ì¬ í™”ë©´ì˜ Mermaid SVGë¥¼ ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜¤ê¸°
    function getMindmapSVGString() {
      const svg = document.querySelector('#mindmap svg');
      if (!svg) return null;

      let { width, height } = svg.getBoundingClientRect();
      const vb = svg.getAttribute('viewBox');
      if ((!svg.getAttribute('width') || !svg.getAttribute('height')) && vb) {
        const parts = vb.split(/\s+/).map(Number);
        if (parts.length === 4) {
          width = parts[2];
          height = parts[3];
        }
      }
      const clone = svg.cloneNode(true);
      clone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      if (width && height) {
        clone.setAttribute('width', String(Math.round(width)));
        clone.setAttribute('height', String(Math.round(height)));
      }
      const xml = new XMLSerializer().serializeToString(clone);
      return `<?xml version="1.0" encoding="UTF-8"?>\n${xml}`;
    }

    //Anchor ë‹¤ìš´ë¡œë“œ í”Œë°±
    function downloadBlobinPage(blob, filename = 'mindmap') {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    //SVG ì €ì¥
    async function exportMindmapSVG() {
      const svgString = getMindmapSVGString();
      if (!svgString) { alert('ì €ì¥í•  ë§ˆì¸ë“œë§µì´ ì—†ìŠµë‹ˆë‹¤.'); return;}
      const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8'});

      if (ipcRenderer) {
        const base64 = btoa(unescape(encodeURIComponent(svgString)));
        const res = await ipcRenderer.invoke('save-file', {
          dataBase64 : base64,
          defaultPath : 'mindmap.svg',
          mime : 'image/svg+xml'
        });
        if (!res?.ok) alert('ì €ì¥ ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨');
      } else {
        downloadBlobinPage(blob, 'mindmap.svg');
      }
    }

    //PNG ì €ì¥ (canvasë¡œ ë˜ìŠ¤í„°í™”; scaleë¡œ í•´ìƒë„ ì„ íƒ)
    async function exportMindmapPNG(scale = 2) {
      const svgString = getMindmapSVGString();
      if (!svgString) { alert('ì €ì¥í•  ë§ˆì´ë“ ë§µì´ ì—†ìŠµë‹ˆë‹¤.'); return;}
      
      // data ULR -> load image
      const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(svgBlob);
      const img = new Image();
      img.onload = async () => {
        const svg = document.querySelector('#mindmap svg');
        let w = img.width, h = img.height;
        if (svg) {
          const vb = svg.getAttribute('viewBox');
          if (vb) {
            const parts = vb.split(/\s+/).map(Number);
            if(parts.length === 4) {
              w = parts[2];
              h = parts[3];
            }
          }
        }
        w = Math.max(1, Math.round(img.width * scale));
        h = Math.max(1, Math.round(img.height * scale));
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.setTransform(scale, 0, 0, scale, 0, 0);
        ctx.drawImage(img, 0, 0);
        URL.revokeObjectURL(url);

        canvas.toBlob(async (blob) => {
          if (!blob) { alert('PNG ë³€í™˜ ì‹¤íŒ¨'); return; }
          if (ipcRenderer) {
            const buf = await blob.arrayBuffer();
            // ArrayBuffer â†’ base64
            let binary = '';
            const bytes = new Uint8Array(buf);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
            const base64 = btoa(binary);
            const res = await ipcRenderer.invoke('save-bytes', {
              dataBase64: base64,
              defaultPath: 'mindmap.png',
              mime: 'image/png'
            });
            if (!res?.ok) alert('ì €ì¥ ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨');
          } else {
            downloadBlobinPage(blob, 'mindmap.png');
          }
        }, 'image/png', 1.0);
      };
      img.onerror = () => { URL.revokeObjectURL(url); alert('SVG ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); };
      img.src = url;
    }

    document.getElementById('mmSaveSVG').onclick = () => exportMindmapSVG();
    document.getElementById('mmSavePNG').onclick = async () => {
      const svgString = getMindmapSVGString();
      if (!svgString) return alert('ì €ì¥í•  ë§ˆì¸ë“œë§µì´ ì—†ìŠµë‹ˆë‹¤.');

      const res = await window.api.saveSvgAsPng({
        svgString,
        defaultPath: 'mindmap.png',
        scale: 4, // 1=ì›ë³¸, 2~4ë¡œ ì˜¬ë¦¬ë©´ ê³ í•´ìƒë„
      });
      if (!res?.ok) alert('ì €ì¥ ì·¨ì†Œ ë˜ëŠ” ì‹¤íŒ¨');
    };


    // ===== ì–´ì‹œìŠ¤í„´íŠ¸ =====
    function renderChat(){
      chatLogEl.innerHTML = chatHistory.map(m =>
        `<div class="msg ${m.role==='user'?'me':'bot'}"><div class="bubble">${escapeHtml(m.text)}</div></div>`
      ).join("");
      chatLogEl.scrollTop = chatLogEl.scrollHeight;
    }
    async function sendChat(){
      const text = chatInputEl.value.trim(); if(!text) return;
      chatInputEl.value = ""; chatHistory.push({role:"user", text}); renderChat();
      try {
        const res = await fetch(`${API}/chat`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ message:text, history:chatHistory }) });
        const data = await res.json();
        chatHistory.push({ role:"assistant", text: data.reply || "(ì‘ë‹µ ì—†ìŒ)" });
      } catch {
        chatHistory.push({ role:"assistant", text: "ì—°ê²° ì˜¤ë¥˜: ì„œë²„ í™•ì¸ í•„ìš”" });
      }
      renderChat();
    }

    // ===== ì´ë²¤íŠ¸ =====
    searchBtn.onclick = fetchList;
    newBtn.onclick = createNote;
    delBtn.onclick = deleteNote;
    saveBtn.onclick = saveNote;

    // âœ… AI ë¶„ì„ ë²„íŠ¼ ë™ì‘
    analyzeBtn.onclick = async () => {
      const title = titleEl.value.trim() || 'Untitled';
      const content = getContent();
      if (!content.trim()) { statusEl.textContent = 'ë¶„ì„í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
      analyzeBtn.disabled = true; analyzeBtn.textContent = 'ë¶„ì„ ì¤‘â€¦';
      try {
        const res = await fetch(`${API}/analyze`, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ title, content })
        });
        const text = await res.text();
        let data = null;
        try { data = JSON.parse(text); } catch {}
        if (!res.ok) {
          console.error('analyze ì‹¤íŒ¨', res.status, text);
          statusEl.textContent = `ë¶„ì„ ì‹¤íŒ¨(${res.status})`;
          if (data) renderAnalysis(data);
          return;
        }
        if (!data) { statusEl.textContent = 'ë¶„ì„ ì‹¤íŒ¨ (ë¹ˆ ì‘ë‹µ)'; return;}
        renderAnalysis(data);
        statusEl.textContent = 'ë¶„ì„ ì™„ë£Œ';
      } catch(e){
        console.error(e);
        statusEl.textContent = 'ë¶„ì„ ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬)';
      } finally {
        analyzeBtn.disabled = false; analyzeBtn.textContent = 'AI ë¶„ì„';
      }
    };

    sendBtn.onclick = sendChat;
    clearChatBtn.onclick = () => { chatHistory=[]; renderChat(); };
    chatInputEl.addEventListener("keydown", e => { if (e.key === "Enter") sendChat(); });

    document.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if ((e.ctrlKey||e.metaKey) && k === "s") { e.preventDefault(); saveNote(); }
      if ((e.ctrlKey||e.metaKey) && k === "n") { e.preventDefault(); createNote(); }
    });

    // ===== Electron IPC & í´ë§ =====
    if (window.electronAPI?.onNotesChanged) {
      window.electronAPI.onNotesChanged(async () => {
        await fetchList();
        if (currentId && !notes.find(n => n.id === currentId)) { currentId = null; setEditor(null); }
      });
    }
    setInterval(() => { fetchList().catch(()=>{}); }, 30000);

    // ===== ì´ˆê¸° ë¡œë”© =====
    (async function init(){
      initEditor();
      await fetchList();
      if (notes[0]) await loadNote(notes[0].id);
      renderChat();
    })();
  </script>
</body>
</html>
